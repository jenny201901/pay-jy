<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<link rel="stylesheet" type="text/css" href="./css/index.css" />
		<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<title>一码付</title>
		<style>

		</style>
	</head>
	<body>

		<!-- 商城名称 -->
		<div class="m10 name"></div>
		<!-- 金额 -->
		<div class="m10 inputbox">
			<span>¥</span>
			<!-- <span class="inpt">0.00</span> -->
			<input type="number" class="inpt" disabled value="0.00">
		</div>

		<div class="money">
			<ul>
				<li>
					<span>1</span>
					<span>2</span>
					<span>3</span>
				</li>
				<li>
					<span>4</span>
					<span>5</span>
					<span>6</span>
				</li>
				<li>
					<span>7</span>
					<span>8</span>
					<span>9</span>
				</li>
				<li>
					<span>.</span>
					<span>0</span>
					<span>删除</span>
				</li>
				<li>
					<span>付款</span>
				</li>
			</ul>
		</div>
		<script>
			var productCode = '';
			var systemCode = '';
			var code = '';
			var appId = '';
			var  openId = '';
			var ftype = false;
			(function() {
				var input = document.querySelector('.inpt'); //金额显示框
				var li = document.querySelectorAll('span'); //按钮集合
				// ====获取当前打开的方式
				var userChannel = GetQueryString("systemCode"); //111
				systemCode = userChannel;
				IsWeixinOrAlipay()
				onblur2();
				//======
				for (let i = 0; i < li.length; i++) {
					li[i].onclick = function() {

						console.log('系统编码===', systemCode)
						console.log('订单金额===', input.innerHTML)
						console.log('支付方式===', productCode)

						if (this.innerHTML == '付款') {
							console.log('点击了完成');
							//如果是微信支付
							if(productCode == 'wxpayOfficial'){
								console.log('微信支付的写法');
								xmlHttp = new XMLHttpRequest();
								var array = {
									systemCode: systemCode, //系统编码	
									orderAmount: input.innerHTML * 100, //订单金额（分）
									productCode: productCode, 	
									appId: appId, 
									clientIp: '127.0.0.1', 
									openId: openId,
								}
								console.log('JSON.stringify(array)====',JSON.stringify(array))
								//  (2) 连接服务器
								//  post
								xmlHttp.open("post", "http://47.116.135.219:9891/api/pay/qrCodePay");
								// 设置请求头的Content-Type
								var ele_csrf = document.getElementsByName("csrfmiddlewaretoken")[0];
								xmlHttp.setRequestHeader("Content-Type", "application/json");
								// （3） 发送数据
								xmlHttp.send(JSON.stringify(array)); // 请求体数据
								// （4） 回调函数  success
								xmlHttp.onreadystatechange = function() {
									if (this.status == 200) {
										console.log("=======qrCodePay=========", this.responseText)
										var obj ={}
										obj =JSON.parse(JSON.parse(this.responseText).payInfo)
										startWxPay(obj)
									}
								};
								return;
							}
							if(productCode == 'alipayH5'){
								console.log('支付宝支付的写法')
								// alert(productCode)
								// 开始调取后端支付接口进行app唤起
								xmlHttp = new XMLHttpRequest();
								var array = {
									systemCode: systemCode, //系统编码	
									orderAmount: input.innerHTML * 100, //订单金额（分）
									productCode: productCode //产品	
								}
								//  (2) 连接服务器
								//  post
								xmlHttp.open("post", "http://47.116.135.219:9891/api/pay/qrCodePay");
								// 设置请求头的Content-Type
								var ele_csrf = document.getElementsByName("csrfmiddlewaretoken")[0];
								xmlHttp.setRequestHeader("Content-Type", "application/json");
								// （3） 发送数据
								xmlHttp.send(JSON.stringify(array)); // 请求体数据
								// （4） 回调函数  success
								xmlHttp.onreadystatechange = function() {
									if (this.status == 200) {
										console.log("=======zhifb=========", this.responseText)	
										if(this.responseText){
											window.location.href = JSON.parse(this.responseText).payInfo;
										}
										
									}
								};
								return;
							}
							return;
						}
						if (this.innerHTML == '删除') { //删除
							if (input.innerHTML == '0.00') {
								input.innerHTML = '0.00'
							} else {
								//清空为最后一个数的时候，给0.00显示（三元运算符）否则就继续删除
								input.innerHTML = input.innerHTML.length == 1 ? input.innerHTML = '0.00' : input.innerHTML.substr(0, input.innerHTML
									.length - 1); //截取长度
							}
						} else if (input.innerHTML == '0.00') { //输入框为0.00
							input.innerHTML = this.innerHTML //当前内容替换成输入内容
						} else if (input.innerHTML.indexOf('.') != -1 && this.innerHTML == '.') {
							input.innerHTML = input.innerHTML //当前内容=当前内容
						} else if (input.innerHTML.indexOf('.') != -1 && input.innerHTML.split('.')[1].length == 2) {
							input.innerHTML = input.innerHTML //当前内容=当前内容
						} else {
							input.innerHTML += this.innerHTML //拼接金额
						}
					}

				}
				// 结束自带
			})()
			// ===支付======
			function startWxPay(res) {
				console.log('startWxPay===res',res)
				if (res.openid != null && res.openid != undefined && res.openid != "") {
					window.localStorage.setItem("openid", res.openid);
				}
				// wx.chooseWXPay({
				// 	appId:res.appid,
				// 	timestamp: res.timestamp, // 支付签名时间戳
				// 	nonceStr: res.noncestr, // 支付签名随机串，不长于32 位
				// 	package: res.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
				// 	signType: "MD5", // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
				// 	paySign: res.paysign, // 支付签名
				// 	success: function(res) {
				// 		//支付成功
				// 		console.log('支付成功')
				// 	}
				// })
				 WeixinJSBridge.invoke(
				      'getBrandWCPayRequest', {
				         "appId":res.appId,     //公众号ID，由商户传入     
				         "timeStamp":res.timeStamp,         //时间戳，自1970年以来的秒数     
				         "nonceStr":res.nonceStr, //随机串     
				         "package":res.package,     
				         "signType":"MD5",         //微信签名方式：     
				         "paySign":res.paySign//微信签名 
				      },
				      function(res){
				      if(res.err_msg == "get_brand_wcpay_request:ok" ){
				      // 使用以上方式判断前端返回,微信团队郑重提示：
				            //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
				      } 
				   }); 
			}
			// =====判断扫码方式
			function IsWeixinOrAlipay() {
				var ua = window.navigator.userAgent;
				// alert('==ua=',ua)
				// alert(ua.indexOf("Alipayclient"))
				// 判断是不是微信还是支付宝登录
				if (ua.indexOf("MicroMessenger") > 0) {
					//return "WeiXIN";  
					console.log('微信')
					this.productCode = "wxpayOfficial";
					// 开始调取后端支付接口进行app唤起
					xmlHttp = new XMLHttpRequest();
					var array = {
						systemCode: systemCode //系统编码
					}
					//  (2) 连接服务器
					xmlHttp.open("post", "http://47.116.135.219:9891/api/pay/wxCodeUrl");
					// 设置请求头的Content-Type
					var ele_csrf = document.getElementsByName("csrfmiddlewaretoken")[0];
					xmlHttp.setRequestHeader("Content-Type", "application/json");
					//xmlHttp.setRequestHeader("X-CSRFToken",ele_csrf.value);
					// （3） 发送数据
					xmlHttp.send(JSON.stringify(array)); // 请求体数据
					// （4） 回调函数  success
					xmlHttp.onreadystatechange = function() {
						if (this.status == 200) {
							// console.log("得到微信codeUrl==", this.responseText)
							if (this.responseText) {
								// console.log('=====', JSON.parse(this.responseText).data)
								if (!GetQueryString('code')) {
									window.location.href = JSON.parse(this.responseText).data
								} else {
									console.log('code---', GetQueryString('code'))
									code = GetQueryString('code');
									// ftype = false;
									if(!ftype){
										userMsg(code)
									}
									
								}
								// window.open(JSON.parse(this.responseText).data)
							}

						}
					};
				}
				// 判断是不是支付宝
				// if (ua.indexOf("Alipayclient") > 0) {
					else{
					// return "Alipay";  
					console.log('支付宝')
					this.productCode = "alipayH5";
				}
				// 哪个都不是
				// return "false";
				console.log('其他')
				// this.productCode = "alipayH5";
			}
			// 得到微信用户信息
			function userMsg(code) {
				// var _this = this;
				ftype = true;
				if(!openId){
					console.log('openId==',openId)
				
				xmlHttp = new XMLHttpRequest();
				var array = {
					"systemCode": systemCode,
					"code": code
				}
				xmlHttp.open("post", "http://47.116.135.219:9891/api/pay/wxOpenId");
				// 设置请求头的Content-Type
				var ele_csrf = document.getElementsByName("csrfmiddlewaretoken")[0];
				xmlHttp.setRequestHeader("Content-Type", "application/json");
				//xmlHttp.setRequestHeader("X-CSRFToken",ele_csrf.value);
				// （3） 发送数据
				console.log("array", array)
				xmlHttp.send(JSON.stringify(array)); // 请求体数据
				// （4） 回调函数  success
				xmlHttp.onreadystatechange = function() {
					if (this.status == 200) {
						console.log("responseText", this.responseText)
						var data = this.responseText;
						if (data) {
							console.log('openid===',data)
							console.log('openid=datadata==',data.data)
							console.log('openid=json==',JSON.parse(data).data)
							console.log('openid=json==',JSON.parse(data).data.openid)
							openId = JSON.parse(data).data.openid;
							// console.log(',o',openid);
							if(openId){
								localStorage.setItem('openid',JSON.parse(data))
							}
							// var name = document.querySelector('.name'); //系统名称
							// name.innerHTML = JSON.parse(this.responseText).data.systemName;
							// console.log(name)
						}

					}
				};
			}
				
			}
			// =====截取链接中 ？ 的 code
			function GetQueryString(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				// var r = 'http://public.cheertea.com/codePay/1.htm?systemCode=001007'
				if (r != null)
					return unescape(r[2]);
				return null;
			}
			// ==== 接口调用方式 系统名称(1)
			function onblur2(value) {
				// 发送ajax
				// （1） 获取 XMLHttpRequest对象
				xmlHttp = new XMLHttpRequest();
				var array = {
					"systemCode": systemCode //企业编号	Y
				}
				//  (2) 连接服务器
				//  get
				//xmlHttp.open("get","/sendAjax/?a=1&b=2");
				//  post
				xmlHttp.open("post", "http://47.116.135.219:9891/api/pay/querySystem");
				// 设置请求头的Content-Type
				var ele_csrf = document.getElementsByName("csrfmiddlewaretoken")[0];
				xmlHttp.setRequestHeader("Content-Type", "application/json");
				//xmlHttp.setRequestHeader("X-CSRFToken",ele_csrf.value);
				// （3） 发送数据
				console.log("array", array)
				xmlHttp.send(JSON.stringify(array)); // 请求体数据
				// （4） 回调函数  success
				xmlHttp.onreadystatechange = function() {
					if (this.status == 200) {
						// console.log("responseText", this.responseText)
						var data = this.responseText;
						if (data) {
							// console.log(JSON.parse(data).data)
							var name = document.querySelector('.name'); //系统名称
							name.innerHTML = JSON.parse(this.responseText).data.systemName;
							// console.log(name)
							appId = JSON.parse(this.responseText).data.appId;
						}

					}
				};
			}
		</script>
	</body>
</html>
